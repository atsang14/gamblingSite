<!DOCTYPE html>
<html>
<head>
	<title></title>
</head>
<body>
	
	<!-- login  -->
<div class="login-page">
	
	<div class="beginning-page">
		<button id="signIn">Sign-In</button>
		<button id="register">Register</button>
	</div>

	<div class="form-pages"> 
			
			<!-- form div if user Does not have an account -->
		<div class="userId">
			<h1>Create User Login</h1>
			<form class="userId">
				<h3>UserName: <input id="userName"></h3>
		 		<h3>Email: <input id="email"></h3>
				<h3>Password: <input id="password"></h3>	
				<button id="submit">Submit</button>
				<button id="back">Back</button>
			</form>
		</div>

			<!-- Login if user does have an account -->
		<div class="userLogin">
			<h1>Enter Your Login Information</h1>
			<form>
				<h3>UserName: <input id="loginUserName"></h3>
				<h3>Password: <input id="loginPassword"></h3>
				<button id="submitLogin">Submit</button>
				<button id="back">Back</button>
			</form>
		</div>
		
		<h2 id="message-display"></h2>
	</div>

</div>
	
	<!-- coin flip game -->
<div class="coin-flip">	
		
		<!-- button to flip-coin, this will be edited into a timer -->
	<div id="pickButton">
		<button class="flip">FlipCoin!</button>
	</div>
	
	<button class="logOut">Log Out</button>

		<!-- coin flip  -->
	<div id="nextFlipTimer"></div>

	<div id="image"><img class="images" src=""></div>

	<div id="status"></div>

		<!-- Shows Who user is currently logged in as -->
	<div class="loggedInAs">Logged In As: <span id="currentUser"></span></div>
	
	<div class="wallet">Wallet: <span id="currentWallet"></span></div>	
		<!-- how many users online -->
	<p>Online: <span id="online"></span></p>
		
		<!-- Past History Location -->
	<div id="pastResults"></div>

		<!-- Chat Box -->
	<div class="chat">
		<form>
	  		<input id="userInput">
	  		<button id="send">send</button>
		</form>

		<div class="theChatBox"></div>
	</div>
	
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/5.2.0/firebase.js"></script>
<script>
	// Initialize Firebase
	// var timer = 0;
	var config = {
	    apiKey: "AIzaSyD_qURuCUdBESLqgWn4antWWaeo9ehikp8",
	    authDomain: "project-1-814ab.firebaseapp.com",
	    databaseURL: "https://project-1-814ab.firebaseio.com",
	    projectId: "project-1-814ab",
	    storageBucket: "project-1-814ab.appspot.com",
	    messagingSenderId: "806088385313"
	};

	firebase.initializeApp(config);

	// Create a variable to reference the database.
	var database = firebase.database();

	// -------------------------------------------------------------- (CRITICAL - BLOCK) --------------------------- //
    // connectionsRef references a specific location in our database.
    // All of our connections will be stored in this directory.
	var connectionsRef = database.ref("/connections");

	// '.info/connected' is a special location provided by Firebase that is updated every time
    // the client's connection state changes.
    // '.info/connected' is a boolean value, true if the client is connected and false if they are not.
	var connectedRef = database.ref(".info/connected");

	connectedRef.on("value", function(snap) {
      
      // If they are connected..
      if (snap.val()) {

        // Add user to the connections list.
        var con = connectionsRef.push(true);

        // Remove user from the connection list when they disconnect.
        con.onDisconnect().remove();
      }

    });


    // When first loaded or when the connections list changes...
    connectionsRef.on("value", function(snap) {

      // Display the viewer count in the html.
      // The number of online users is the number of children in the connections list.
      $("#online").text(snap.numChildren());
    });

// -----------------------------------------------------------------------
// -----------------------Flip Coin---------------------------------------
// -----------------------------------------------------------------------
	
	var baseTime 		   = "1531389600"; // subtract this by the Date.now() and the % to get remainder.
	var clearDiv 		   = 0;
	var pastResultsArray   = [];
	var currentUrl		   = '';
	var users 			   = [];
	var loggedInUser	   = ''; // this variable holds the userName of the Currently logged in user.
	var loggedInUserWallet = 0;
	// var timerStart		 = 5;	// this variable will dictate how long the timer will last 
	// var flipTimer;

	$('.coin-flip').hide();

	// keeps track of the clearDiv by storing the value in Firebase's Database
	// the purpose of this is to make sure the div doesn't get too big.
	// so when clearDiv variable goes past 10, we will clear the div.
	
	database.ref().on('value', function(snapshot) {
 		
 		users = snapshot.val().users;

 	});

	database.ref("/pastResultsCounter").on("value", function(snapshot) {

		pastResultsArray = snapshot.val().pastResultsArray;
		
		$('#pastResults').text('');
		
		for (var i = 0; i < 10; i++) {

			var span = $('<span>').text(pastResultsArray[pastResultsArray.length - (i+1)].timeStamp);
			var p = $('<p>').append(pastResultsArray[pastResultsArray.length - (i+1)].timeResult);
			p.append('\t').append(span);
			$('#pastResults').prepend(p);
		}

		$('.images').attr('src', snapshot.val().imgUrl);

	});


	// when user clicks button run the game
	$(document).on('click','.flip',function() {

		flipCoin();

	});

	// this function flips coin and randomizes which will be displayed depending 
	// on the randomization.
	function flipCoin() {

		var timeStamp 	= new Date().toISOString();
		var random 		= Math.floor(Math.random() * 2);
		
		$('#pastResults').text('');
	 	
		if (random == 0) {
			
			var result = {
				timeStamp: timeStamp,
				timeResult: 'Heads'
			}
			
			$('.images').attr('src', 'http://random-ize.com/coin-flip/us-quarter/us-quarter-front.jpg');

			pastResultsArray.push(result);
			
			for (var i = 0; i < 10; i++ ){
				var span = $('<span>').text(timeStamp);
				var p = $('<p>').append(pastResultsArray[pastResultsArray.length - (i+1)].timeResult);
				p.append('\t').append(span);
				$('#pastResults').append(p);
			
			}
			
			database.ref("/pastResultsCounter").set({
        		pastResultsArray,
        		imgUrl: 'http://random-ize.com/coin-flip/us-quarter/us-quarter-front.jpg'
     		});
		
		} else if (random == 1) {
			
			var result = {
				timeStamp: timeStamp,
				timeResult: 'Tails'
			}

			$('.images').attr('src', 'http://random-ize.com/coin-flip/us-quarter/us-quarter-back.jpg');
			
			pastResultsArray.push(result);

			for (var i = 0; i < 10; i++ ){
				var span = $('<span>').text(timeStamp);
				var p = $('<p>').append(pastResultsArray[pastResultsArray.length - (i+1)].timeResult);
				p.append('\t').append(span);
				$('#pastResults').append(p);
			}

			database.ref("/pastResultsCounter").set({
        		pastResultsArray,
        		imgUrl: 'http://random-ize.com/coin-flip/us-quarter/us-quarter-back.jpg'
     		});
		}
	}

	$('.logOut').on('click', function() {

		$('.login-page').show();
		$('.coin-flip').hide();

	});

// -----------------------------------------------------------------------
// ---------------------Login Info----------------------------------------
// -----------------------------------------------------------------------
	
	$('.userId').hide();
	$('.userLogin').hide();

	$('#register').on('click', function() {

		$('#register').hide();
		$('#signIn').hide();
		$('.userId').show();

	});

	// user creates an account if they click 'Register' button
	// if the userName or email has already been take (checked by looping through the users object stored in firebase) the we 
	// tell the user the email or userName has already been taken.

	$('#submit').on('click', function() {

		event.preventDefault();	
		
		var userName = '';
		var	email	 = '';
		var password = '';
		var timeStamp 	= new Date().toISOString();

		var errorUserName = 'User Name has already been take. Please choose another user name.';

		var errorEmail 	  = 'Email is already in use, please use another email address';
		
		var userNameAndEmailError = 'Both Username and Email are currently in use. Please try again :]';

		$('#message-display').text('');

		userName 	 = $('#userName').val().toLowerCase().trim();
		email	 	 = $('#email').val().toLowerCase().trim();
		password 	 = $('#password').val().toLowerCase().trim();

		if ((userName == '') || (email == '') || (password == '')){

			$('#message-display').append('Finish The Form *****');
			return;

		}

		for (var key in users) {

			if((userName === users[key].user_Name) && (email === users[key].user_Email)){

				$('#message-display').append(userNameAndEmailError);
				return;

			} else if (email === users[key].user_Email) {

				$('#message-display').append(errorEmail);
				return;

 			} else if (userName === users[key].user_Name) {

 				$('#message-display').append(errorUserName);
 				return;
 			}
 		}

		var userInfo     = {

			user_Name: userName,
			user_Email: email,
			user_Password: password,
			status: 'Logged In',
			wallet: 100,
			time_Account_Created: timeStamp

		}		

		database.ref('/users').push(
			userInfo
      	);

		loggedInUser = userName;

      	$('#userName').val('');
      	$('#email').val('');
      	$('#password').val('');

      	// Display page wanted here after user created an account
      	$('.login-page').hide();
      	$('.coin-flip').show();

      	$('#currentUser').text(loggedInUser);

	});

	$('#signIn').on('click', function() {

		$('#register').hide();
		$('#signIn').hide();Â 
		$('.userLogin').show();
	
	});


	// when user clicks submit, this code will check to see if 
	// it's in the database and if the user name and password matches the information in the database.
	// if it does, it allows the user to see the page.
	// if it doesn't then user cannot log in.

	$('#submitLogin').on('click', function() {

		event.preventDefault();	

		var userName = '';
		var password = '';
		userName 	 = $('#loginUserName').val().toLowerCase().trim();
		password 	 = $('#loginPassword').val().toLowerCase().trim();

		var errorMsg = 'Wrong user Name or Password';

		$('#message-display').text('');

		if ((userName == '') || (password == '')){

			$('#message-display').append('Finish The Form *****');
			return;

		}
		
		$('#message-display').text('');

		for(var keys in users) {

			if ((userName === users[keys].user_Name) && (password === users[keys].user_Password)) {

				alert("You are now logged in!");
				
				// show page once login here
				
				// Show user name and wallet of user
				loggedInUser 	   = userName;
				loggedInUserWallet = 	users[keys].wallet;
				
				$('#loginUserName').val('');
				$('#loginPassword').val('');
				
				$('.login-page').hide();
      			$('.coin-flip').show();

      			$('#currentUser').text(loggedInUser);
      			$('#currentWallet').text(loggedInUserWallet);
				
				return;

			} 
		}
		

		$('#message-display').append(errorMsg);

	});
	
	// this back button brings the user to the option menu
	// where they can chose to register or log in.
	$('#back').on('click', function() {

		$('.form-pages').hide();
		$('.beginning-page').show();

	}); 


// -----------------------------------------------------------------------
// -----------------------ChatBox-----------------------------------------
// -----------------------------------------------------------------------
	database.ref().on("value", function(snapshot) {

	    $('.theChatBox').text('');
        var chatBoxStart   = [];
        chatBoxStart       =   snapshot.val().chatBox;

        var counter     = 0;
        var displayChat = [];

        for(var theKey in chatBoxStart) {
        	counter ++;
      	}

      	var weWant      = counter - 2;
      	var newCounter  = 0;

        for(var theKeys in chatBoxStart) {
        	newCounter++;
        	if(newCounter == weWant) {
          		displayChat.push(chatBoxStart[theKeys]);
          		weWant++;
          		if(weWant > counter){
            		break;
          		}
        	}
      	}

      	for (var i = 0; i < 3; i++) {
        	var pTag    = $('<p>').append(':'+displayChat[i].chatText);
        	$('.theChatBox').append(pTag);
      	}
	  	
	});

	// when user clicks send, updates the page for everybody tuned in
    $('#send').on('click', function() {
    
	    event.preventDefault(); 

	    var timeStamp   = new Date().toISOString();
	    var chatText    = '';

	    chatText        = $('#userInput').val();
	    
	    if(chatText != '') {
	    
	      	var chatObject  = {
		        
		        timeStamp: timeStamp,
		        chatText: chatText,
		        userNameSent: loggedInUser

	      	}
	      
	      	// hell is happening between line 93 - 95
	     	database.ref('/chatBox').push(
	        	chatObject
	      	); 

      	$('#userInput').val('');

    	}
 	});
	

	
	

	
	

	
	

	
	

	
	

	
	

	
	

	
	

	
	

	
	

	
	

	
	
	// This function also runs on a 5 second timer.
	// Every 5 seconds, the function will call itself to make the game repeat.
	// function timer() {
		
	// 	flipTimer = setInterval(function() {

	// 		if(timerStart >= 0){

	// 			$('#nextFlipTimer').text(timerStart--);

	// 		} else {
				
	// 			flipCoin();
				
	// 			if(clearDiv > 10) {

	// 				$('#pastResults').text('');
	// 				clearDiv = 0;
	// 				pastResultsArray = [];

	// 			}	

	// 			timerStart = 5;
				
	// 			clearInterval(flipTimer);

	// 			timer();

	// 		}
	// 	}, 1000);
	// }



		
		// $('#guessHere').text($(this).attr('class'));

		// if(userChoice == random){
		// 	wins++
		// 	$('#wonNumber').text(wins);
		// 	$('#status').text('Winner!');
		// } else{
		// 	losses++
		// 	$('#lossNumber').text(losses);
		// 	$('#status').text('Loser!');
		// }
		
		// if(userChoice == 0){
		// 	headsChosen++
		// 	$('#chosenHeadsNumber').text(headsChosen);
		// } else if (userChoice == 1){
		// 	tailsChosen++
		// 	$('#chosenTailsNumber').text(tailsChosen);
		// }

</script>
</body>
</html>